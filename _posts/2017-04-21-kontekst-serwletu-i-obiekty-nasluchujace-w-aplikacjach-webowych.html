---
layout: default
title: Kontekst serwletu i obiekty nasłuchujące w aplikacjach webowych
excerpt: "W artykule przeczytasz o kolejnych podstawowych elementach, niezbędnych
  do budowania aplikacji webowych w Javie. Dowiedz się czym jest kontekst serwletu
  (ang. <em>servlet context</em>) i jak możesz go używać. Poznasz cykl życia aplikacji
  webowej i dowiesz się o zdarzeniach (ang. <em>events</em>), na które
  możesz reagować. Całość przećwiczysz rozwiązując zadanie znajdujące się na końcu
  artykułu.\r\n\r\n"
date: '2017-04-21 16:04:41 +0200'
categories:
- DSP2017
- Kurs aplikacji webowych
---
<p>W artykule przeczytasz o kolejnych podstawowych elementach, niezbędnych do budowania aplikacji webowych w Javie. Dowiedz się czym jest kontekst serwletu (ang. <em>servlet context</em>) i jak możesz go używać. Poznasz cykl życia aplikacji webowej i dowiesz się o zdarzeniach (ang. <em>events</em>), na które możesz reagować. Całość przećwiczysz rozwiązując zadanie znajdujące się na końcu artykułu.</p>
<p><a id="more"></a><a id="more-863"></a></p>
<h1><code>ServletContext</code></h1><br />
Obiekt implementujący <a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html" target="_blank" rel="noopener noreferrer"><code>ServletContext</code></a> tworzony jest przez kontener serwletów. Istnieje tylko jeden taki obiekt dla każdej aplikacji webowej [0. Właściwie to, istnieje tylko jeden taki obiekt dla każdej wirtualnej maszyny Java. Jjeśli twoja aplikacja webowa jest rozproszona wówczas obiektów implementujących ten interfejs jest tyle, ile instancji JVM.]. Służy on głównie do współdzielenia informacji w ramach aplikacji internetowej.</p>
<p>Czytając poprzednie artykuły z serii:</p>
<ul>
<li><a href="http://www.samouczekprogramisty.pl/serwlety-w-aplikacjach-webowych/">serwlety w aplikacjach webowych</a>,</li>
<li><a href="http://www.samouczekprogramisty.pl/naglowki-sesje-i-ciasteczka/">nagłówki, sesje i ciasteczka w aplikacjach webowych</a>,</li>
<li><a href="http://www.samouczekprogramisty.pl/filtry-w-aplikacjach-webowych/">filtry w aplikacjach webowych</a>,</li><br />
</ul><br />
poznałeś inne konteksty/zakresy. Na przykład kontekst zapytania i kontekst sesji HTTP. W każdym z tych kontekstów mogłeś ustawić zestaw atrybutów. Atrybuty te &ldquo;żyły&rdquo; tak długo, jak aktywny był dany kontekst.</p>
<p>Podobnie jest tutaj. Z tym, że kontekst serwletu jest tylko jeden i aktywny jest przez cały czas &ldquo;życia&rdquo; aplikacji webowej. Podobnie jak w poprzednich przypadkach możesz w nim ustawiać atrybuty.</p>
<h2>Atrybuty kontekstu</h2><br />
Podobnie jak <code>Servlet</code> czy <code>HttpRequest</code> mają atrybuty, tak samo jest z <code>ServletContext</code>. Możesz ustawiać dowolne atrybuty w kontekście. Dzięki temu, że istnieje jeden kontekst dla całej aplikacji możesz w ten sposób przekazywać informacje pomiędzy serwletami.</p>
<p>Do pracy z atrybutami przechowywanymi w obiekcie implementującym <code>ServletContext</code> służą metody:</p>
<ul>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html#setAttribute-java.lang.String-java.lang.Object-" target="_blank" rel="noopener noreferrer"><code>setAttribute</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html#getAttribute-java.lang.String-" target="_blank" rel="noopener noreferrer"><code>getAttribute</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html#getAttributeNames--" target="_blank" rel="noopener noreferrer"><code>getAttributeNames</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html#removeAttribute-java.lang.String-" target="_blank" rel="noopener noreferrer"><code>removeAttribute</code></a>.</li><br />
</ul><br />
Instancję implementującą ten interfejs możemy uzyskać wywołując metodę <a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#getServletContext--" target="_blank" rel="noopener noreferrer"><code>getServletContext</code></a> znajdującą się w interfejsie <a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html" target="_blank" rel="noopener noreferrer"><code>ServletRequest</code></a>.</p>
<p>Dzięki dostępowi do kontekstu serwletów możesz przekazywać atrybuty pomiędzy poszczególnymi serwletami. Przykładowy serwlet poniżej wyświetla wszystkie atrybuty kontekstu ustawiając wcześniej wartość jednego z nich.</p>
<pre class="lang:default decode:true ">@WebServlet("/servlet1")<br />
public class Servlet1 extends HttpServlet {</p>
<p>    @Override<br />
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {<br />
        PrintWriter writer = resp.getWriter();<br />
        writer.write("<html><body>");</p>
<p>        ServletContext context = req.getServletContext();<br />
        context.setAttribute("pl.samouczekprogramisty.servlet1", "servlet1 attribute");</p>
<p>        Enumeration<String> attributeNames = context.getAttributeNames();<br />
        while (attributeNames.hasMoreElements()) {<br />
            String attributeName = attributeNames.nextElement();<br />
            writer.write("
<p>" + attributeName + ": " + context.getAttribute(attributeName) + "
<p>");<br />
        }<br />
        writer.write("</body></html>");<br />
    }<br />
}</pre><br />
Spróbuj uruchomić aplikację, która ma taki serwlet. Wpisując adres serwletu w przeglądarce zobaczysz wszystkie atrybuty kontekstu. Poza atrybutem ustawionym przez serwlet zobaczysz także inne, część z nich jest ustawiona przez sam kontener serwletów.</p>
<p>Dokumentacja zaleca aby nazwy atrybutów były zapisane w podobnej konwencji jak pakiety. Innymi słowy nazwy powinny wyglądać jak &ldquo;odwrócone adresy www&rdquo;, na przykład <code>pl.samouczekprogramisty.servelet1</code>.</p>
<h2>Dynamiczna konfiguracja</h2><br />
Ponadto twórcy bibliotek dzięki dostępowi do obiektu <code>ServletContext</code> mogą dynamicznie tworzyć serwlety, filtry czy obiekty nasłuchujące zdarzenia (ang. <em>listener</em>). Funkcjonalność ta raczej nie jest wykorzystywana w innych przypadkach.</p>
<h1>Obiekty nasłuchujące</h1><br />
Szczerze mówiąc miałem tu problem z tłumaczeniem :). Chodzi tu o obiekty, które potocznie nazywamy "listenerami". Obiekty nasłuchujące nie są specyficzne dla aplikacji webowych. Koncept tego typu używany jest także w innych miejscach. Jest to jeden z szeroko znanych wzorców projektowych. Wzorzec ten nazywany jest obserwatorem (ang. <em>observer</em>).</p>
<p>Kontener serwletów ma informację o wystąpieniu pewnych zdarzeń. Ty jako programista możesz chcieć być informowany o tych zdarzeniach. Na przykład chcesz dostać informację kiedy obiekt <code>ServletContext</code> zostanie utworzony. Aby to zrobić tworzysz własną instancję obiektu nasłuchującego, który implementuje interfejs <a href="http://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html" target="_blank" rel="noopener noreferrer"><code>ServletContextListener</code></a>. Dodatkowo tę implementację oznaczasz adnotacją <a href="https://docs.oracle.com/javaee/7/api/javax/servlet/annotation/WebListener.html" target="_blank" rel="noopener noreferrer"><code>@WebListener</code></a>. Dzięki temu kontener serwletów wie o twojej klasie. Wie, że musi ją powiadomić o takim zdarzeniu.</p>
<p>Poniższy diagram pokazuje jak te komponenty układają się w całość:</p>
<p><a href="http://www.samouczekprogramisty.pl/wp-content/uploads/2017/04/wzorzec_observer.jpeg"><img class="aligncenter size-medium wp-image-869" src="http://www.samouczekprogramisty.pl/wp-content/uploads/2017/04/wzorzec_observer-300x188.jpeg" alt="Wzorzec observer" width="300" height="188" /></a></p>
<p>Kontener przechowuje listę obiektów implementujących interfejs <code>ServletContextListener</code>. Jedną z implementacji może być klasa <code>MyOwnImplementation</code> pokazana na diagramie. Następnie w każdym momencie kiedy wystąpi zdarzenie, którym interesuje się nasza implementacja kontener uruchamia odpowiednie metody. Metody te są zdefiniowane w iterfejsie <code>ServletContextListener</code>.</p>
<p>Zdarzenia dotyczące kontekstu nie są jedynymi. W trakcie działania aplikacji webowej występuje wiele zdarzeń. Zdarzenia te związane są z cyklem życia poszczególnych elementów aplikacji. Na przykład możesz być poinformowany o tym, że została utworzona sesja HTTP, albo o tym, że jakieś zapytanie zostało wysłane do aplikacji.</p>
<p>Poniżej znajduje się lista kilka przykładowych interfejsów obiektów nasłuchujących:</p>
<ul>
<li><a href="http://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html" target="_blank" rel="noopener noreferrer"><code>ServletContextListener</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextAttributeListener.html" target="_blank" rel="noopener noreferrer"><code>ServletContextAttributeListener</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestListener.html" target="_blank" rel="noopener noreferrer"><code>ServletRequestListener</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestAttributeListener.html" target="_blank" rel="noopener noreferrer"><code>ServletRequestAttributeListener</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionListener.html" target="_blank" rel="noopener noreferrer"><code>HttpSessionListener</code></a>,</li>
<li><a href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionAttributeListener.html" target="_blank" rel="noopener noreferrer"><code>HttpSessionAttributeListener</code></a>.</li><br />
</ul><br />
Na przykład, obiekt implementujący interfejs <code>ServletContextAttributeListener</code> zostanie poinformowany o wszystkich operacjach na atrybutach kontekstu serwletu.</p>
<p>Aby kontener serwletów wiedział o obiekcie nasłuchującym trzeba go odpowiednio skonfigurować. Każdy z obiektów nasłuchujących powinien być dekorowany wspomnianą adnotacją <code>@WebListener</code> [1. Może też być zdefiniowany w pliku <code>web.xml</code>, <code>web-fragment.xml</code> czy dodany dynamicznie przez metody dostępne w <code>ServletContext</code>, jednak te sposoby wykraczają poza zakres tego artykułu.].</p>
<p>Poniżej znajduje się przykładowa implementacja interfejsu <code>ServletContextListener</code>, która dodaje dodatkowy atrybut w momencie utworzenia kontekstu serwletu:</p>
<pre class="lang:default decode:true ">@WebListener<br />
public class MyServletContextListener implements ServletContextListener {</p>
<p>    @Override<br />
    public void contextInitialized(ServletContextEvent sce) {<br />
        sce.getServletContext().setAttribute("pl.samouczekprogramisty.listener", "listener value");<br />
    }</p>
<p>    @Override<br />
    public void contextDestroyed(ServletContextEvent sce) {<br />
        // do nothing<br />
    }<br />
}</pre></p>
<h2>Praktyczne wykorzystanie</h2><br />
W poprzednich artykułach opisujących elementy specyfikacji serwletów odwoływałem się do Spring MVC. Nie inaczej będzie i tym razem. Przykładowym obiektem nasłuchującym zaimplementowanym w Spring MVC może być <a href="https://github.com/spring-projects/spring-framework/blob/v4.3.8.RELEASE/spring-web/src/main/java/org/springframework/web/util/WebAppRootListener.java" target="_blank" rel="noopener noreferrer"><code>WebAppRootListener</code></a>. Obiekt ten reaguje na utworzenie/zniszczenie kontekstu serwletów. Zachęcam Cię do przeszukania kodu źródłowego Spring MVC pod kątem innych obiektów, które reagują na zdarzenia w aplikacji webowej.</p>
<p>Implementacja odpowiednich interfejsów, które pozwalają reagować na zdarzenia umożliwia konfigurację Spring MVC. W praktyce &ldquo;magiczny Spring&rdquo; nie robi nic innego jak wykorzystuje elementy specyfikacji serwletów.</p>
<h1>Ćwiczenie do wykonania</h1><br />
Napisz serwlet, który wyświetli wszystkie atrybuty kontekstu. Dodatkowo niech serwlet ten dodaje parametry przekazane w adresie URL jako atrybuty kontekstu. Na przykład żądanie na adres <code>.../serwlet?pl.parametr=xxx</code> powinno utworzyć atrybut kontekstu o nazwie <code>pl.parametr</code> z wartością <code>xxx</code>.</p>
<p>Uzupełnij tę aplikację o implementację interfejsu <code>ServletContextAttributeListener</code>. Niech twój słuchacz w momencie dodawania nowego atrybuty kontekstu doda kolejny atrybut z datą jego dodania. Na przykład jeśli dodamy atrybut o nazwie <code>pl.parametr</code> to automatycznie powinien zostać dodany atrybut <code>pl.parametr.when</code>. Wartością nowego atrybutu powinna być data dodania atrybutu.</p>
<p>Pamiętaj żeby zabepieczyć się przed "nieskończoną pętlą" - twój obiekt zostanie także powiadomiony o dodaniu atrybutu <code>pl.parametr.when</code> i wtedy spróbuje dodać kolejny <code>pl.pamrater.when.when</code>, o którym także byłby powiadomiony.</p>
<p>Jeśli będziesz miał problem z rozwiązaniem zadania możesz rzucić okiem na <a href="https://github.com/SamouczekProgramisty/KursAplikacjeWebowe/tree/master/04_kontekst/src/main/java/pl/samouczekprogramisty/kursaplikacjewebowe/exercise" target="_blank" rel="noopener noreferrer">przykładowe rozwiązanie</a>. Jak zwykle jednak zachęcam do samodzielego rozwiązania zadania. Wtedy nauczysz się najwięcej.</p>
<h1>Dodatkowe materiały do nauki</h1></p>
<ul>
<li><a href="http://download.oracle.com/otndocs/jcp/servlet-3_1-fr-eval-spec/index.html" target="_blank" rel="noopener noreferrer">Specyfikacja serwletów</a>,</li>
<li><a href="https://en.wikipedia.org/wiki/Observer_pattern" target="_blank" rel="noopener noreferrer">Artykuł na wikipedii nt. wzorca projektowego observer</a>,</li>
<li><a href="https://github.com/SamouczekProgramisty/KursAplikacjeWebowe/tree/master/04_kontekst/src/main/java/pl/samouczekprogramisty/kursaplikacjewebowe" target="_blank" rel="noopener noreferrer">Kod źródłowy przykładów użytych w artykule</a>.</li><br />
</ul></p>
<h1>Podsumowanie</h1><br />
Wiesz już czym jest <code>ServletContext</code> i do czego może być używany. Poznałeś przykłady obiektów nasłuchujących zdarzeń w aplikacjach webowych. Znasz przykłady praktycznego ich wykorzystania. Po wykonaniu ćwiczenia potrafisz zastosować tę wiedzę w praktyce. Innymi słowy poznałeś mechanizmy, pozwalające na działanie aplikacji webowych :).</p>
<p>Mam nadzieję, ze artykuł Ci się podobał. Jeśli nie chcesz pominąć kolejnych zapisz się do samouczkowego newslettera i polub stronę na facebooku.</p>
<p>Na koniec mam do Ciebie prośbę. Zależy mi na dotarciu do jak największego grona czytelników. Możesz mi w tym pomóc przekazując link do artykułu swoim znajomym. Z góry dziękuję i do następnego razu!</p>
<p>[FM_form id="3"]</p>
<p>Zdjęcie dzięki uprzejmości https://www.flickr.com/photos/fkhuckel/33244430220/sizes/l</p>
